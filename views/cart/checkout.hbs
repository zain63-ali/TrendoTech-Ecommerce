{{!-- Checkout Page - Order placement form with payment options --}}
<div class="container my-5">
    {{!-- Page header with title aur back to cart link --}}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Checkout</h1>
        <a href="/cart" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Cart
        </a>
    </div>
    
    {{!-- Error message display agar koi error hai --}}
    {{#if error}}
    <div class="alert alert-danger mb-4">
        {{error}}
    </div>
    {{/if}}
    
    <div class="row">
        {{!-- Checkout Form Section --}}
        <div class="col-lg-8">
            <div class="card mb-4">
                {{!-- Shipping details card header --}}
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Shipping Details</h5>
                </div>
                <div class="card-body">
                    {{!-- Main checkout form with file upload support --}}
                    <form action="/cart/place-order" method="POST" id="checkout-form" enctype="multipart/form-data">
                        {{!-- Customer information row --}}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="fullName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="fullName" name="fullName" value="{{user.name}}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{user.email}}" required>
                            </div>
                        </div>
                        
                        {{!-- Shipping address field --}}
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address" name="address" required>
                        </div>
                        
                        {{!-- City aur state row --}}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="city" class="form-label">City *</label>
                                <input type="text" class="form-control" id="city" name="city" required>
                            </div>
                            <div class="col-md-6">
                                <label for="state" class="form-label">State/Province *</label>
                                <input type="text" class="form-control" id="state" name="state" required>
                            </div>
                        </div>
                        
                        {{!-- Zip code aur country row --}}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="zipCode" class="form-label">Zip/Postal Code *</label>
                                <input type="text" class="form-control" id="zipCode" name="zipCode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="country" class="form-label">Country *</label>
                                <select class="form-select" id="country" name="country" required>
                                    <option value="" selected disabled>Select a country</option>
                                    <option value="US">Pakistan</option>   
                                </select>
                            </div>
                        </div>
                        
                        {{!-- Payment Method Selection Card --}}
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Payment Method</h5>
                            </div>
                            <div class="card-body">
                                {{!-- Cash on Delivery option --}}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="cash_on_delivery" checked>
                                    <label class="form-check-label" for="cashOnDelivery">
                                        <i class="fas fa-money-bill-wave me-2"></i>Cash on Delivery
                                    </label>
                                </div>
                                
                                {{!-- JazzCash payment option --}}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="jazzcash" value="jazzcash">
                                    <label class="form-check-label" for="jazzcash">
                                        <i class="fas fa-mobile-alt me-2"></i>JazzCash
                                    </label>
                                </div>
                                {{!-- JazzCash payment fields (hidden by default) --}}
                                {{!-- Bank Transfer payment fields (hidden by default) --}}
                                <div class="bank-transfer-fields mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Bank Transfer Instructions:</strong>
                                        <ol class="mb-0 mt-2">
                                            <li>Bank: HBL</li>
                                            <li>Account Title: TrendoTech</li>
                                            <li>Account Number: 12345678901234</li>
                                            <li>Upload transaction receipt below</li>
                                        </ol>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="bankTransactionId" class="form-label">Transaction ID *</label>
                                            <input type="text" class="form-control" id="bankTransactionId" name="bankTransactionId" placeholder="Enter transaction ID">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="bankReceipt" class="form-label">Transaction Receipt *</label>
                                            <input type="file" class="form-control" id="bankReceipt" name="bankReceipt" accept="image/*">
                                            <div class="form-text">Upload a clear photo of your bank receipt</div>
                                        </div>
                                    </div>
                                </div>
                                {{!-- Bank Transfer payment option --}}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="bank_transfer">
                                    <label class="form-check-label" for="bankTransfer">
                                        <i class="fas fa-university me-2"></i>Bank Transfer
                                    </label>
                                </div>
                                <div class="bank-transfer-fields mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Bank Transfer Instructions:</strong>
                                        <ol class="mb-0 mt-2">
                                            <li>Transfer payment to our bank account below</li>
                                            <li>Use your order total as the amount</li>
                                            <li>Take a screenshot of the transaction receipt</li>
                                            <li>Upload the screenshot and fill in transaction details</li>
                                        </ol>
                                        <hr>
                                        <p class="mb-1"><strong>Our Bank Account Details:</strong></p>
                                        <p class="mb-1">Account Title: TrendoTech E-commerce</p>
                                        <p class="mb-1">Account Number: 1234-5678-9012-3456</p>
                                        <p class="mb-0">Bank Name: Allied Bank Limited</p>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="accountTitle" class="form-label">Your Account Title *</label>
                                            <input type="text" class="form-control" id="accountTitle" name="accountTitle" placeholder="Account holder name">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="accountNumber" class="form-label">Your Account Number *</label>
                                            <input type="text" class="form-control" id="accountNumber" name="accountNumber" placeholder="Your account number">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="bankName" class="form-label">Your Bank Name *</label>
                                            <input type="text" class="form-control" id="bankName" name="bankName" placeholder="Your bank name">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="transactionId" class="form-label">Transaction ID *</label>
                                            <input type="text" class="form-control" id="transactionId" name="transactionId" placeholder="Transaction reference number">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="bankTransferScreenshot" class="form-label">Transaction Screenshot *</label>
                                        <input type="file" class="form-control" id="bankTransferScreenshot" name="transactionScreenshot" accept="image/*">
                                        <div class="form-text">Upload a clear screenshot of your bank transfer receipt</div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        
                        {{!-- Terms and conditions checkbox --}}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="termsAgree" required>
                            <label class="form-check-label" for="termsAgree">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
                            </label>
                        </div>
                        
                        {{!-- Place order submit button --}}
                        <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="fas fa-lock me-2"></i>Place Order
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        {{!-- Order Summary Sidebar --}}
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    {{!-- Subtotal amount --}}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>{{subtotal}}</span>
                    </div>
                    {{!-- Shipping cost (free) --}}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping:</span>
                        <span>Free</span>
                    </div>
                    {{!-- Tax calculation (10%) --}}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax (10%):</span>
                        <span>{{tax}}</span>
                    </div>
                    <hr>
                    {{!-- Final total amount --}}
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Total:</strong>
                        <strong>{{total}}</strong>
                    </div>
                </div>
            </div>
            
            {{!-- Order Items List Card --}}
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Order Items ({{cartItems.length}})</h5>
                </div>
                <div class="card-body p-0">
                    {{!-- Cart items list --}}
                    <ul class="list-group list-group-flush">
                        {{#each cartItems}}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{!-- Product image aur details --}}
                            <div class="d-flex align-items-center">
                                <img src="{{this.product.imageUrl}}" class="img-thumbnail me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="{{this.product.name}}">
                                <div>
                                    <h6 class="mb-0">{{this.product.name}}</h6>
                                    <small class="text-muted">Qty: {{this.quantity}}</small>
                                </div>
                            </div>
                            {{!-- Item total price (quantity * price) --}}
                            <span>Rs. {{multiply this.product.price this.quantity}}</span>
                        </li>
                        {{/each}}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{{!-- Terms and Conditions Modal --}}
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {{!-- Terms content --}}
            <div class="modal-body">
                <h5>1. General Terms</h5>
                <p>By placing an order through our website, you agree to these terms and conditions. We reserve the right to modify these terms at any time, so please review them frequently.</p>
                
                <h5>2. Pricing and Payment</h5>
                <p>All prices are shown in PKR and include applicable taxes. Payment is required at the time of purchase. We accept various payment methods as shown on the checkout page.</p>
                
                <h5>3. Shipping and Delivery</h5>
                <p>Delivery times vary based on your location and the availability of products. We are not responsible for delays due to customs or other factors outside our control.</p>
                
                <h5>4. Returns and Refunds</h5>
                <p>You may return items within 30 days of delivery for a full refund. Items must be unused and in their original packaging. Please contact our customer service team to initiate a return.</p>
                
                <h5>5. Privacy Policy</h5>
                <p>Your personal information is collected and used in accordance with our Privacy Policy. By placing an order, you consent to our collection and use of your information as described in the Privacy Policy.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing payment method handlers...');
        
        // Payment method change handler
        function togglePaymentFields() {
            console.log('togglePaymentFields called');
            
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            console.log('Selected payment method:', selectedMethod ? selectedMethod.value : 'none');
            
            // Get field containers
            const jazzcashFields = document.querySelector('.jazzcash-fields');
            const bankTransferFields = document.querySelector('.bank-transfer-fields');
            
            console.log('JazzCash fields found:', !!jazzcashFields);
            console.log('Bank Transfer fields found:', !!bankTransferFields);
            
            // Hide all fields first
            if (jazzcashFields) {
                jazzcashFields.style.display = 'none';
                console.log('Hidden JazzCash fields');
            }
            if (bankTransferFields) {
                bankTransferFields.style.display = 'none';
                console.log('Hidden Bank Transfer fields');
            }
            
            // Remove all required attributes
            document.querySelectorAll('.jazzcash-fields input, .bank-transfer-fields input').forEach(function(input) {
                input.required = false;
                input.removeAttribute('required');
            });
            
            // Show relevant fields based on selection
            if (selectedMethod) {
                const method = selectedMethod.value;
                console.log('Processing method:', method);
                
                if (method === 'jazzcash') {
                    console.log('Showing JazzCash fields...');
                    if (jazzcashFields) {
                        jazzcashFields.style.display = 'block';
                        console.log('JazzCash fields displayed');
                        
                        // Make fields required
                        const jazzcashNumber = document.getElementById('jazzcashNumber');
                        const transactionScreenshot = document.getElementById('transactionScreenshot');
                        
                        if (jazzcashNumber) {
                            jazzcashNumber.required = true;
                            jazzcashNumber.setAttribute('required', 'required');
                        }
                        if (transactionScreenshot) {
                            transactionScreenshot.required = true;
                            transactionScreenshot.setAttribute('required', 'required');
                        }
                    }
                } else if (method === 'bank_transfer') {
                    console.log('Showing Bank Transfer fields...');
                    if (bankTransferFields) {
                        bankTransferFields.style.display = 'block';
                        console.log('Bank Transfer fields displayed');
                        
                        // Make fields required
                        const fields = [
                            document.getElementById('accountTitle'),
                            document.getElementById('accountNumber'),
                            document.getElementById('bankName'),
                            document.getElementById('transactionId'),
                            document.getElementById('bankTransferScreenshot')
                        ];
                        
                        fields.forEach(function(field) {
                            if (field) {
                                field.required = true;
                                field.setAttribute('required', 'required');
                            }
                        });
                    }
                } else {
                    console.log('Cash on Delivery selected - no extra fields needed');
                }
            }
        }
        
        // Add event listeners to payment method radio buttons
        const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
        console.log('Found payment method radios:', paymentRadios.length);
        
        paymentRadios.forEach(function(radio, index) {
            console.log('Adding listener to radio', index, 'value:', radio.value);
            radio.addEventListener('change', function() {
                console.log('Payment method changed to:', this.value);
                togglePaymentFields();
            });
        });
        
        // Initialize on page load
        console.log('Initializing payment fields...');
        togglePaymentFields();
        
        // Enhanced form validation with Bootstrap support
        // Checkout form submission ke liye validation
        document.getElementById('checkout-form').addEventListener('submit', function(e) {
            const form = this;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            
            // Bootstrap validation pehle check karein
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                form.classList.add('was-validated');
                return false;
            }
            
            // Payment methods ke liye additional custom validation
            if (paymentMethod === 'jazzcash') {
                const jazzcashNumber = document.getElementById('jazzcashNumber')?.value?.trim();
                const screenshot = document.getElementById('transactionScreenshot')?.files[0];
                
                if (!jazzcashNumber) {
                    e.preventDefault();
                    alert('Please enter your JazzCash number');
                    document.getElementById('jazzcashNumber')?.focus();
                    return false;
                }
                
                if (!screenshot) {
                    e.preventDefault();
                    alert('Please upload a screenshot of your JazzCash transaction');
                    document.getElementById('transactionScreenshot')?.focus();
                    return false;
                }
            } else if (paymentMethod === 'bank_transfer') {
                const accountTitle = document.getElementById('accountTitle')?.value?.trim();
                const accountNumber = document.getElementById('accountNumber')?.value?.trim();
                const bankName = document.getElementById('bankName')?.value?.trim();
                const transactionId = document.getElementById('transactionId')?.value?.trim();
                const screenshot = document.getElementById('bankTransferScreenshot')?.files[0];
                
                if (!accountTitle || !accountNumber || !bankName || !transactionId) {
                    e.preventDefault();
                    alert('Please fill in all bank transfer details');
                    // Pehle empty field par focus karein
                    if (!accountTitle) document.getElementById('accountTitle')?.focus();
                    else if (!accountNumber) document.getElementById('accountNumber')?.focus();
                    else if (!bankName) document.getElementById('bankName')?.focus();
                    else if (!transactionId) document.getElementById('transactionId')?.focus();
                    return false;
                }
                
                if (!screenshot) {
                    e.preventDefault();
                    alert('Please upload a screenshot of your bank transfer transaction');
                    document.getElementById('bankTransferScreenshot')?.focus();
                    return false;
                }
            }
            
            // Agar yahan tak pahunche to validation pass ho gayi
            form.classList.add('was-validated');
        });
    });
</script> 